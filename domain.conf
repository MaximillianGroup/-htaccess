# Apache Configuration File for WordPress (multisite) or PHP Application
# Author: MaximillianGroup (Max Barrett) <maximilliangroup@gmail.com>
# Version 1.0.0
# WordPress and WordPress Multisite, Cloudflare Origin Certificates, Let's Encrypt, Strong SSL Security
# Contact: support@maximilliangroup.us

ServerAdmin webmaster@maximilliangroup.us

# Load essential modules
# If already loaded comment these out
LoadModule ssl_module modules/mod_ssl.so  # Enables SSL/TLS
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so  # Shared memory cache for sessions and stapling
LoadModule rewrite_module modules/mod_rewrite.so  # URL rewriting (required for WordPress Multisite)
LoadModule headers_module modules/mod_headers.so  # For setting custom headers
LoadModule expires_module modules/mod_expires.so #For browser caching
LoadModule deflate_module modules/mod_deflate.so #For enabling Gzip

# Tell Apache to Listen (if already set, comment out)
Listen 80
Listen 443

# Minimize server information disclosure (security best practice)
ServerTokens Prod
ServerSignature Off

SetEnv TZ "UTC"  # Or php_value date.timezone "UTC" if using mod_php
LimitRequestBody 10240000

# Define your ServerRoot if it's non-standard (uncomment and adjust if needed)
# ServerRoot "/etc/apache2"




# SSL Stapling Configuration (improves SSL/TLS handshake performance)
<IfModule mod_ssl.c>
  SSLStaplingCache "shmcb:/var/log/apache2/ssl_stapling(32768)"  # Using shared memory cache
</IfModule>

<VirtualHost>
    ServerName sparxstar.com
    ServerAlias www.sparxstar.com

    DocumentRoot /var/www/html  # Your WordPress root directory – ADJUST IF NEEDED

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

</VirtualHost>

# ----------------------------------
# HTTP VirtualHost (Port 80): Redirects all HTTP traffic to HTTPS
# ----------------------------------
<VirtualHost *:80>
    ServerName sparxstar.com  # Repeat ServerName inside this virtualhost
    ServerAlias www.sparxstar.com

    # Rewrite to HTTPS ONLY
    RewriteEngine On
    RewriteRule ^/?(.*) https://%{SERVER_NAME}%{REQUEST_URI} [R=301,L] # Permanent redirect to HTTPS

</VirtualHost>

# ----------------------------------
# HTTPS VirtualHost (Port 443): Main configuration for your WordPress Multisite
# ----------------------------------
<VirtualHost *:443>
   <IfModule mod_ssl.c>
        SSLEngine on  # Enables SSL/TLS for this virtual host
    
        # and Let's Encrypt
        SSLCertificateFile /etc/letsencrypt/live/sparxstar.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/sparxstar.com/privkey.pem
        SSLCertificateChainFile /etc/letsencrypt/live/sparxstar.com/chain.pem
    
        # SSL Certificate Configuration (using Cloudflare origin certificates)
        SSLCertificateFile /etc/ssl/certs/cloudflare-origin.pem #Path to your certificate file
        SSLCertificateKeyFile /etc/ssl/certs/cloudflare-origin.key # Path to your private key file
        SSLCertificateChainFile /etc/ssl/certs/cloudflare-ecc-chain.pem  # Path to the chain file, if applicable
        # Cloudflare Origin Chain File at 
        # https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/#cloudflare-origin-ca-root-certificate

        # CIPHER SUITES - comment out the one not used

        # OPTION 1 - Strong Cipher Suite and Cipher Order (important for security)
        SSLCipherSuite HIGH:!aNULL:!MD5:!RC4  # Disables weak ciphers

        # OPTION 2 - Stronger Cipher Suite with Future Proofing
        # Recommended Mozilla Modern Cipher Suite (adjust as needed for compatibility)
        SSLCipherSuite TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
        SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1  # Disable older, insecure protocols

        # BOTH OPTION REQUIRE
        # Enforces server's cipher preference
        SSLHonorCipherOrder on  
        # Enable OCSP Stapling (for faster SSL handshakes)
        SSLUseStapling on
    </IfModule>

    <IfModule mod_headers.c>
        # Reinforce HTTPS ONLY - comment out if allowing HTTP connections (NOT RECOMMENDED)
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

        # Remove and mention of the server
        Header unset Server

        # Content Security Policy (CSP) – **CUSTOMIZE THIS VERY CAREFULLY** (see notes readme.md)
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' *.sparxstar.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: *.sparxstar.com; font-src 'self' data:; connect-src 'self'; object-src 'none'; frame-ancestors 'none';"  # Customize!

        # CORS related headers
        Header set Referrer-Policy "no-referrer, strict-origin-when-cross-origin"  # Good to have this here
        Header always set Expect-CT "enforce, max-age=0"  # Good to have this as well

        # Important Security Headers
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"  # Enforces HTTPS
        Header always set X-Frame-Options "DENY"  # Prevents clickjacking
        Header always set X-Content-Type-Options "nosniff" # Prevents MIME-sniffing attacks
        Header always set Referrer-Policy "strict-origin-when-cross-origin"  # Controls referrer information
    <IfModule>

     <IfModule mod_mime.c>
        AddDefaultCharset utf-8  
        
    </IfModule>

    # Root Directory – ADJUST IF NEEDED
    # Directory configurations for your applications.
    # Add separate <Directory> blocks for each application with its own AllowOverride settings)
    <Directory /var/www/html>  

         # Allows .htaccess overrides for these types ONLY – ADJUST IF NEEDED
        AllowOverride FileInfo AuthConfig Limit

        # Allows access to all. Change if you need more specific access controls.
        Require all granted 

        #Browser caching of static assets
        <IfModule mod_expires.c> 
            ExpiresActive On
            ExpiresByType image/jpg "access 1 year"
            # ... other ExpiresByType directives ...
            ExpiresDefault "access 2 days" # Default caching time
        </IfModule>
  
         #Gzip Compression
         <IfModule mod_deflate.c>
              <FilesMatch "\.(js|css|html|xml|php)$">
                  SetOutputFilter DEFLATE
                  DeflateCompressionLevel 9
              </FilesMatch>
          </IfModule>

          # File Access Restrictions (can  be in .htaccess here)
          <FilesMatch "\.((md|exe|sh|bak|inc|pot|po|mo|log|sql|htaccess|htpasswd|ini|phps|fla|psd|log|sh|env|
                          settings\.php|security\.php
                          wp-config\.php|config\.php|db\.php|db-config\.php|debug\.log|install\.php|license\.txt|readme\.txt|
                          wp-content/uploads/|\.git|upload\.php|options\.php|themes|plugins|backup|
                          \.(php[3-7]?|phtml|sql|bak|sqlite|yml|conf|conf\.php|ini|tpl|tmp|log|
                          |key|pem|p12|crt|)$">
              Require all denied
          </FilesMatch>


    </Directory>

</VirtualHost>
